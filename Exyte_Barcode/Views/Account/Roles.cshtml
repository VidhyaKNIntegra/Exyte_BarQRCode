
@{ ViewBag.Title = "Roles";
    Layout = "~/Views/Shared/_Layout.cshtml"; }

    <div class="container">
        <div class="page-heading d-sm-flex justify-content-sm-between align-items-sm-center">
            <h2 class="title mb-3 mb-sm-0">
                Roles
            </h2>
            <nav class="mb-0 breadcrumb">
                <a style="float:right; margin-right:10px;" class="btn btn-primary pull-right" data-toggle='modal' data-bind="click:ClearOldData" data-target='#myModal2'><i class='zmdi zmdi-plus-circle-o zmdi-hc-fw'></i> Add Roles</a>
            </nav>
        </div>
        <div class="gx-card">
            <div class="gx-card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover dataTables-example" id="roleTable"></table>
                </div>
            </div>
        </div>
    </div>
<div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Edit Details</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="gx-card">
                            <div class="gx-card-header">
                                <h3 class="card-title">Role</h3>
                                <input type="hidden" class="form-control" id="RoleIdtxt" />
                            </div>
                            <div class="gx-card-body">
                                <form>
                                    <div class="form-group">
                                        <label for="RoleNameTxt"> Role Name :  </label>
                                        <input type="text" class="form-control" disabled data-bind="value:Name" id="RoleNameTxt" />
                                        <span id="RoleNameTxtErr" style="font-size:12px;color:red;"></span>
                                    </div>
                                    <div class="form-group">
                                        <label for="RoleNameTxt"> Role Description :  </label>
                                        <input type="text" class="form-control" data-bind="value:Description" id="RoleDescTxt" />
                                        <span id="RoleDescTxtErr" style="font-size:12px;color:red;"></span>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="gx-card">
                            <div class="gx-card-header">
                                <h3 class="card-title">Menu Permissions</h3>
                            </div>
                            <div class="gx-card-body">
                                <form>
                                    <div class="form-group row" style="margin-bottom:0rem">
                                        <ul type="none" id="wkslist1"></ul>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" data-bind="click:UpdateRoleDetails"><i class='zmdi zmdi-check-circle-u zmdi-hc-fw'></i> Update</button>
                <button type="button" class="btn btn-default" style="color:white;background-color:dimgray" data-dismiss="modal"><i class='zmdi zmdi-close-circle-o zmdi-hc-fw'></i>Close</button>
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="myModal2" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Add Role</h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-1"></div>
                    <div class="col-md-10">
                        <div class="form-group">
                            <div class="row">
                                <div class="col-sm-4">
                                    <div class="text-right">
                                        <label for="ProjectId">Role Name : </label>
                                    </div>
                                </div>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" data-bind="value:RoleName" id="RoleNameTxt" />
                                    <span id="RoleNameErr" style="color:red;font-size:12px;"></span>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-sm-4">
                                    <div class="text-right">
                                        <label for="RoleDescriptionTxt">Role Description : </label>
                                    </div>
                                </div>
                                <div class="col-sm-8">
                                    <input type="text" class="form-control" data-bind="value:RoleDescription" id="RoleDescriptionTxt" />
                                    <span id="RoleDescriptionTxtErr" style="color:red;font-size:12px;"></span>
                                </div>
                            </div>

                        </div>
                        <div class="form-group">
                            <div class="row">
                                <div class="col-sm-4">
                                    <div class="text-right">
                                        <label>Menu Permission : </label>
                                    </div>
                                </div>
                                <div class="col-sm-8">
                                    <div class="gx-card">
                                        <div class="gx-card-body">
                                            <ul type="none" id="wkslist"></ul>
                                        </div>
                                    </div>
                                    <span id="wkslistErr" style="color:red;font-size:12px;"></span>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="col-md-1"></div>
                </div>

            </div>
            <div class="modal-footer">
                <button class="btn btn-success" data-bind="click:AddRole">Add Role</button>
                <button class="btn btn-primary" data-bind="click:ClearOldData">Clear</button>
            </div>
        </div>

    </div>
</div>

<script>
    var UserID = '@Session["UserID"]';
    var UserName = '@Session["UserName"]';
    var CategoryID = '@Session["CategoryID"]';
    GetRoles();
    function GetRoles() {
        $.ajax({
        type: "GET",
        //url: "/Account/GetRoles",
        url: '@Url.Action("GetRoles", "Account")',
        contentType: "application/json",
        //data: { "id": UserID },
        success: function (data) {

            $('#roleTable').DataTable({
                data: data,
                "bDestroy":true,
                columns: [
                    { 'data': 'Id', 'title': 'SL. NO.' },
                    { 'data': 'RoleName', 'title': 'NAME', 'className': 'text-left' },
                    { 'data': 'RoleDescription', 'title': 'DESCRIPTION', 'className': 'text-left' },
                    {
                        'data': 'RoleId',
                        'title': 'ACTION',
                        "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                            $(nTd).html("<i class='zmdi zmdi-edit zmdi-hc-fw text-success' style='cursor: pointer;' onclick='editRole(" + oData.RoleId + ")' data-toggle='modal' data-target='#myModal' ></i>" +
                                "&nbsp;&nbsp;<i class='zmdi zmdi-delete zmdi-hc-fw text-danger' style='cursor: pointer;' onclick='DeleteRole(" + oData.RoleId + ")' value='Delete' id='Delete'></i> ");
                        }

                    }
                ]
            });
        }
    });
    }

    loadMenuListAddEdit($('#wkslist'),false);
    loadMenuListAddEdit($('#wkslist1'), true);

    function loadMenuListAddEdit(control,isSerial) {
        var permissionid = "permission";
        if (isSerial)
            permissionid = "permission1";
        $.ajax({
            type: "GET",
            //url: "/Account/GetMenuList",
            url: '@Url.Action("GetMenuList", "Account")',
            contentType: "application/json",
            success: function (data) {
                var data1 = data.filter(item=>item.ParentMenu == null);
                $.each(data1, function (key, value) {
                    var ulArr = data.filter(item=>item.ParentMenu == value.MenuId);
                    var ul = '';
                    if (ulArr.length > 0) {
                        ul = ul + '<ul>';
                        $.each(ulArr, function (key1, value1) {
                            ul = ul + '<li><input type="checkbox" name="' + permissionid + '" value="' + value1.MenuId +
                                '" id="' + value1.MenuId + '" />' + "  " + '<label for="' + value1.MenuName + '">' +
                                value1.MenuName + '</label></li>'
                        });
                        ul = ul + '</ul>';
                    }

                    //var li = $('<li><input type="checkbox" name="' + value.MenuName + '" id="' + value.MenuId + '"/>' + "  " +
                    var li = $('<li><input type="checkbox" name="' + permissionid + '" value="' + value.MenuId + '" id="' +
                        value.MenuId + '" />' + "  " + '<label for="' + value.MenuName + '">' + value.MenuName + '</label>' + ul + '</li>');

                    //li.find('label').text(value.MenuName);

                    control.append(li);
                });
            }
        });
    }


    function editRole(Id) {

        $.ajax({
            type: "GET",
            //url: "/Account/GetParticularRole/" + Id,
            url: '@Url.Action("GetParticularRole", "Account")',
            contentType: "application/json",
            data: { id: Id },
            success: function (data) {
                $('#RoleIdtxt').val(data[0].RoleId);
                //$('#RoleNameTxt').val(data[0].RoleName);
                self.Name(data[0].RoleName);
                self.Description(data[0].RoleDescription);
                $("input[name='permission1']").prop("checked", false);
                $.each(data[0].Permissions, function (key, value) {
                    $("input[name='permission1'][value=" + value + "]").prop('checked', true);
                });
            },
            error: function (error) {
                sweetAlert("Error",error.status + '' + error.statusText,  "error");
            }
        });
    }


    function DeleteRole(Id) {
        swal({
            title: "Are you sure?",
            text: "You will not be able to recover this again!",
            type: "warning",
            showCancelButton: true,
            confirmButtonColor: '#DD6B55',
            confirmButtonText: 'Yes, I am sure!',
            cancelButtonText: "No, cancel it!",
            closeOnConfirm: false,
            closeOnCancel: false
        },
        function(isConfirm){

            if (isConfirm){
                $.ajax({
                    type: "POST",
                    url: '@Url.Action("DeleteRole", "Account")',
                    data: ko.toJSON({ id: Id}),
                    contentType: "application/json",
                    success: function (data) {
                        if (data == 'success') {
                            sweetAlert("Success","Deleted successfully!",  "success");
                            GetRoles();
                        }
                    },
                    error: function (error) {
                        sweetAlert("Error",error.status + '' + error.statusText,  "error");
                    }
                });
            } else {
              swal("Cancelled", "You have cancelled the operation.", "error");
            }
        }
     );
}

    var ViewModel = function (items) {
        var self = this;
        self.Id = ko.observable(items.Id);
        self.RoleName = ko.observable(items.RoleName);
        self.RoleDescription = ko.observable(items.RoleDescription);

    }

    var RolessDetailsViewModel = function () {

        self.RoleName = ko.observable();
        self.RoleDescription = ko.observable();
        self.Name = ko.observable();
        self.Description = ko.observable();

        self.ClearOldData = function () {
            self.RoleName("");
            self.RoleDescription("");
            $("input[type='checkbox']").prop("checked",false);
        }

        self.AddRole = function () {
            if (self.RoleName() == undefined || self.RoleName()=="") {
                $('#RoleNameErr').text('Enter the role name');
            }
            else {
                var SelectedCheckbox = [];
                $.each($("input[name='permission']:checked"), function () {
                    SelectedCheckbox.push($(this).val());
                });
                if (SelectedCheckbox.length > 0) {
                    var PData = {
                        RoleName: self.RoleName,
                        RoleDescription: self.RoleDescription,
                        Permissions: SelectedCheckbox,
                        UserId: UserID
                    }
                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("AddNewRole", "Account")',
                        data: ko.toJSON(PData),
                        contentType: "application/json",
                        success: function (data) {
                            if (data == 'success') {
                                sweetAlert("Success","Role Added successfully!",  "success");
                                $("#myModal2").modal("hide");
                                GetRoles();
                            }
                            else {
                                sweetAlert("Error","Role already exists",  "error");
                            }
                        },
                        error: function (error) {
                            sweetAlert("Error",error.status + '' + error.statusText,  "error");
                        }
                    });
                }
                else {
                    $('#wkslistErr').text('Please select menu');
                }
            }

        }

        self.Clear = function () {
            self.RoleName('');
            self.RoleDescription('');
        }

        self.UpdateRoleDetails = function () {
            var SelectedCheckbox1 = [];
            $.each($("input[name='permission1']:checked"), function () {
                SelectedCheckbox1.push($(this).val());
            });
            var roleId = $('#RoleIdtxt').val();
            var sign = {
                RoleName: self.Name(),
                RoleDescription: self.Description(),
                Permissions: SelectedCheckbox1,
                UserId: UserID,
                RoleId: roleId
            }

            $.ajax({
                type: "POST",
                url: '@Url.Action("UpdateRole", "Account")',
                data: ko.toJSON(sign),
                contentType: "application/json",
                success: function (data) {
                    if (data == 'success') {
                        $('#myModal').modal("hide");
                        sweetAlert("Success","updated successfully" , "success");
                        GetRoles();
                    }
                    else {
                        sweetAlert("Error",'Update failed. Please try again!',  "error");
                    }
                },
                error: function (error) {
                    sweetAlert("Error",error.status + '' + error.statusText,  "error");
                }
            });
        }
    };
    ko.applyBindings(new RolessDetailsViewModel());

</script>


